# è½»é‡çº§æ—¶é—´è½®å®ç°

## æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäºæ—¶é—´è½®ç®—æ³•çš„è½»é‡çº§å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨å®ç°ï¼Œæ”¯æŒæ¯«ç§’çº§ç²¾åº¦çš„å®šæ—¶ä»»åŠ¡è°ƒåº¦ï¼Œå…·æœ‰é«˜æ€§èƒ½ã€ä½å»¶è¿Ÿã€å¯æ‰©å±•ç­‰ç‰¹ç‚¹ã€‚

## æ ¸å¿ƒç‰¹æ€§

- âœ… **é«˜æ€§èƒ½**: O(1)æ—¶é—´å¤æ‚åº¦æ·»åŠ å’Œåˆ é™¤ä»»åŠ¡
- âœ… **é«˜ç²¾åº¦**: æ”¯æŒæ¯«ç§’çº§ç²¾åº¦çš„å®šæ—¶è°ƒåº¦
- âœ… **å¯æ‰©å±•**: æ”¯æŒæº¢å‡ºæ—¶é—´è½®å¤„ç†é•¿æ—¶é—´å»¶è¿Ÿ
- âœ… **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨åŸå­æ“ä½œå’ŒåŒæ­¥æœºåˆ¶
- âœ… **æ˜“ç”¨æ€§**: æä¾›ç®€æ´çš„APIæ¥å£
- âœ… **è½»é‡çº§**: æ— å¤–éƒ¨ä¾èµ–ï¼Œçº¯Javaå®ç°

## æ¶æ„è®¾è®¡

```
TimeWheelScheduler (è°ƒåº¦å™¨)
    â†“
TimeWheel (æ—¶é—´è½®æ ¸å¿ƒ)
    â†“
TimeWheelBucket[] (æ—¶é—´è½®æ¡¶æ•°ç»„)
    â†“
TimerTaskList (ä»»åŠ¡é“¾è¡¨)
    â†“
TimerTask (å®šæ—¶ä»»åŠ¡)
```

### æ ¸å¿ƒç»„ä»¶

#### 1. TimeWheelScheduler

- **ä½œç”¨**: æä¾›ç”¨æˆ·å‹å¥½çš„APIæ¥å£
- **åŠŸèƒ½**: ç®¡ç†æ—¶é—´è½®ç”Ÿå‘½å‘¨æœŸï¼Œä»»åŠ¡æ‰§è¡Œè°ƒåº¦
- **ç‰¹æ€§**: æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥ä»»åŠ¡æ‰§è¡Œ

#### 2. TimeWheel

- **ä½œç”¨**: æ—¶é—´è½®æ ¸å¿ƒç®—æ³•å®ç°
- **åŠŸèƒ½**: ä»»åŠ¡åˆ†é…ã€æ—¶é—´æ¨è¿›ã€æº¢å‡ºå¤„ç†
- **ç‰¹æ€§**: æ”¯æŒå±‚çº§æ—¶é—´è½®ç»“æ„

#### 3. TimeWheelBucket

- **ä½œç”¨**: æ—¶é—´è½®æ¡¶ï¼Œç®¡ç†åŒä¸€æ—¶é—´æ ¼å­å†…çš„ä»»åŠ¡
- **åŠŸèƒ½**: ä»»åŠ¡å­˜å‚¨ã€è¿‡æœŸå¤„ç†
- **ç‰¹æ€§**: å®ç°Delayedæ¥å£ï¼Œæ”¯æŒå»¶è¿Ÿé˜Ÿåˆ—

#### 4. TimerTaskList

- **ä½œç”¨**: ä»»åŠ¡é“¾è¡¨ï¼Œç®¡ç†æ¡¶ä¸­çš„ä»»åŠ¡
- **åŠŸèƒ½**: ä»»åŠ¡æ·»åŠ ã€åˆ é™¤ã€éå†
- **ç‰¹æ€§**: åŒå‘é“¾è¡¨ï¼ŒO(1)æ“ä½œå¤æ‚åº¦

#### 5. TimerTask

- **ä½œç”¨**: å®šæ—¶ä»»åŠ¡å°è£…
- **åŠŸèƒ½**: ä»»åŠ¡æ‰§è¡Œã€çŠ¶æ€ç®¡ç†
- **ç‰¹æ€§**: æ”¯æŒä»»åŠ¡IDã€åˆ›å»ºæ—¶é—´è·Ÿè¸ª

## å¿«é€Ÿå¼€å§‹

### 1. åŸºæœ¬ä½¿ç”¨

```java
// åˆ›å»ºè°ƒåº¦å™¨
TimeWheelScheduler scheduler = new TimeWheelScheduler();
scheduler.

start();

// å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡
scheduler.

schedule(1,TimeUnit.SECONDS, () ->{
        System.out.

println("1ç§’åæ‰§è¡Œçš„ä»»åŠ¡");
});

// åœæ­¢è°ƒåº¦å™¨
        scheduler.

stop();
```

### 2. å¼‚æ­¥ä»»åŠ¡

```java
// å¼‚æ­¥æ‰§è¡Œä»»åŠ¡
CompletableFuture<String> future = scheduler.scheduleAsync(2, TimeUnit.SECONDS, () -> {
            return "å¼‚æ­¥ä»»åŠ¡ç»“æœ";
        });

// å¤„ç†ç»“æœ
future.

thenAccept(result ->{
        System.out.

println("ä»»åŠ¡ç»“æœ: "+result);
});
```

### 3. è‡ªå®šä¹‰é…ç½®

```java
// è‡ªå®šä¹‰æ—¶é—´è½®å‚æ•°
// tickMs: 100msç²¾åº¦, wheelSize: 100ä¸ªæ ¼å­
TimeWheelScheduler scheduler = new TimeWheelScheduler(100, 100);
scheduler.

start();
```

## API å‚è€ƒ

### TimeWheelScheduler

#### æ„é€ å‡½æ•°

```java
// é»˜è®¤æ„é€ å‡½æ•° (100msç²¾åº¦, 100ä¸ªæ ¼å­)
TimeWheelScheduler()

// è‡ªå®šä¹‰æ„é€ å‡½æ•°
TimeWheelScheduler(long tickMs, int wheelSize)
```

#### ä¸»è¦æ–¹æ³•

```java
// å¯åŠ¨è°ƒåº¦å™¨
void start()

// åœæ­¢è°ƒåº¦å™¨
void stop()

// å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡
void schedule(long delay, TimeUnit unit, Runnable task)

// å¼‚æ­¥æ‰§è¡Œä»»åŠ¡
CompletableFuture<Void> scheduleAsync(long delay, TimeUnit unit, Runnable task)

// å¼‚æ­¥æ‰§è¡Œä»»åŠ¡å¹¶è¿”å›ç»“æœ
<T> CompletableFuture<T> scheduleAsync(long delay, TimeUnit unit, Supplier<T> supplier)

// æ£€æŸ¥è°ƒåº¦å™¨çŠ¶æ€
boolean isStarted()

// è·å–æ—¶é—´è½®ä¿¡æ¯
long getCurrentTime()

int getWheelSize()

long getInterval()
```

## ç®—æ³•åŸç†

### æ—¶é—´è½®ç®—æ³•

æ—¶é—´è½®æ˜¯ä¸€ç§é«˜æ•ˆå¤„ç†å¤§é‡å®šæ—¶ä»»åŠ¡çš„æ•°æ®ç»“æ„ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯å°†æ—¶é—´åˆ†å‰²æˆå›ºå®šå¤§å°çš„æ ¼å­ï¼Œæ¯ä¸ªæ ¼å­ä»£è¡¨ä¸€ä¸ªæ—¶é—´é—´éš”ã€‚

#### ä»»åŠ¡åˆ†é…ç®—æ³•

```java
// è®¡ç®—ä»»åŠ¡åº”è¯¥æ”¾åœ¨å“ªä¸ªæ¡¶ä¸­
long virtualId = (expiration / tickMs);  // è™šæ‹Ÿæ—¶é—´ID
int index = (int) (virtualId % wheelSize);  // æ¡¶ç´¢å¼•
```

**ç¤ºä¾‹**:

- æ—¶é—´è½®: 100msç²¾åº¦ï¼Œ100ä¸ªæ ¼å­
- ä»»åŠ¡å»¶è¿Ÿ: 500ms
- è®¡ç®—: virtualId = 500/100 = 5, index = 5%100 = 5
- ç»“æœ: ä»»åŠ¡æ”¾åœ¨ç¬¬5ä¸ªæ¡¶ä¸­

#### æº¢å‡ºæ—¶é—´è½®æœºåˆ¶

å½“ä»»åŠ¡å»¶è¿Ÿæ—¶é—´è¶…è¿‡å½“å‰æ—¶é—´è½®çš„ `interval` æ—¶ï¼Œä¼šåˆ›å»ºæº¢å‡ºæ—¶é—´è½®ï¼š

```
ä¸»æ—¶é—´è½® (100ms Ã— 100 = 10ç§’)
    â†“
æº¢å‡ºæ—¶é—´è½® (10ç§’ Ã— 100 = 1000ç§’)
    â†“
æ›´å¤šå±‚çº§...
```

### å·¥ä½œæµç¨‹

#### 1. ä»»åŠ¡æ·»åŠ æµç¨‹

```
ç”¨æˆ·è°ƒç”¨ schedule() 
    â†“
åˆ›å»º TimerTask
    â†“
TimeWheel.addTask()
    â†“
è®¡ç®—æ¡¶ç´¢å¼• (virtualId % wheelSize)
    â†“
æ·»åŠ åˆ°å¯¹åº”æ¡¶çš„ TimerTaskList
    â†“
æ¡¶æ·»åŠ åˆ° DelayQueueï¼ˆå¦‚æœé¦–æ¬¡æ·»åŠ ï¼‰
```

#### 2. ä»»åŠ¡æ‰§è¡Œæµç¨‹

```
å®šæ—¶å™¨è§¦å‘ run()
    â†“
æ¨è¿›å½“å‰æ—¶é—´ advanceClock()
    â†“
ä» DelayQueue å–å‡ºåˆ°æœŸæ¡¶
    â†“
æ¡¶.flush() å¤„ç†æ‰€æœ‰ä»»åŠ¡
    â†“
æ£€æŸ¥ä»»åŠ¡æ˜¯å¦è¿‡æœŸ
    â†“
è¿‡æœŸ: ç›´æ¥æ‰§è¡Œ task.run()
æœªè¿‡æœŸ: é‡æ–°æ·»åŠ åˆ°æ—¶é—´è½® addTask()
```

## æ€§èƒ½ç‰¹ç‚¹

### æ—¶é—´å¤æ‚åº¦

| æ“ä½œ   | æ—¶é—´å¤æ‚åº¦ | è¯´æ˜         |
|------|-------|------------|
| æ·»åŠ ä»»åŠ¡ | O(1)  | ç›´æ¥è®¡ç®—æ¡¶ç´¢å¼•å¹¶æ·»åŠ  |
| åˆ é™¤ä»»åŠ¡ | O(1)  | ä»é“¾è¡¨ä¸­ç§»é™¤èŠ‚ç‚¹   |
| æŸ¥æ‰¾ä»»åŠ¡ | O(1)  | é€šè¿‡æ¡¶ç´¢å¼•ç›´æ¥å®šä½  |
| æ‰§è¡Œä»»åŠ¡ | O(1)  | ä»å»¶è¿Ÿé˜Ÿåˆ—å–å‡ºæ¡¶   |

### ç©ºé—´å¤æ‚åº¦

- **å†…å­˜å ç”¨**: O(n)ï¼Œnä¸ºä»»åŠ¡æ•°é‡
- **æ¡¶æ•°é‡**: å›ºå®šå¤§å°ï¼Œä¸éšä»»åŠ¡æ•°é‡å¢é•¿
- **æº¢å‡ºæ—¶é—´è½®**: æŒ‰éœ€åˆ›å»ºï¼Œå±‚çº§æ·±åº¦æœ‰é™

### æ€§èƒ½ä¼˜åŠ¿

1. **é«˜æ•ˆ**: ç›¸æ¯”ä¼ ç»Ÿå®šæ—¶å™¨ï¼Œæ—¶é—´è½®ç®—æ³•æ•ˆç‡æ›´é«˜
2. **ç²¾ç¡®**: æ”¯æŒæ¯«ç§’çº§ç²¾åº¦çš„å®šæ—¶è°ƒåº¦
3. **å¯æ‰©å±•**: æ”¯æŒæº¢å‡ºæ—¶é—´è½®å¤„ç†é•¿æ—¶é—´å»¶è¿Ÿ
4. **ä½å»¶è¿Ÿ**: ä»»åŠ¡æ‰§è¡Œå»¶è¿Ÿæœ€å°åŒ–

## ä½¿ç”¨åœºæ™¯

### 1. è®¢å•è¶…æ—¶å¤„ç†

```java
TimeWheelScheduler scheduler = new TimeWheelScheduler();
scheduler.

start();

// åˆ›å»ºè®¢å•æ—¶è®¾ç½®è¶…æ—¶å¤„ç†
scheduler.

schedule(30,TimeUnit.MINUTES, () ->{
        // è®¢å•è¶…æ—¶ï¼Œæ‰§è¡Œå–æ¶ˆé€»è¾‘
        orderService.

cancelOrder(orderId);
});
```

### 2. ç¼“å­˜è¿‡æœŸç®¡ç†

```java
// è®¾ç½®ç¼“å­˜æ—¶æ·»åŠ è¿‡æœŸå¤„ç†
scheduler.schedule(ttlSeconds, TimeUnit.SECONDS, () ->{
        // ç¼“å­˜è¿‡æœŸï¼Œæ¸…ç†ç¼“å­˜
        cache.

remove(key);
});
```

### 3. å¿ƒè·³æ£€æµ‹

```java
// å®šæœŸå‘é€å¿ƒè·³
scheduler.schedule(5,TimeUnit.SECONDS, () ->{
        // å‘é€å¿ƒè·³åŒ…
        heartbeatService.

sendHeartbeat(serverId);
});
```

### 4. å»¶è¿Ÿé˜Ÿåˆ—

```java
// å®ç°å»¶è¿Ÿé˜Ÿåˆ—åŠŸèƒ½
scheduler.schedule(delayMs, TimeUnit.MILLISECONDS, () ->{
        // å»¶è¿Ÿæ¶ˆæ¯å¤„ç†
        messageProcessor.

process(message);
});
```

## é…ç½®å»ºè®®

### æ—¶é—´è½®å‚æ•°é€‰æ‹©

| åœºæ™¯    | tickMs | wheelSize | é€‚ç”¨å»¶è¿ŸèŒƒå›´ |
|-------|--------|-----------|--------|
| é«˜é¢‘çŸ­å»¶è¿Ÿ | 1ms    | 1000      | 0-1ç§’   |
| ä¸€èˆ¬åº”ç”¨  | 100ms  | 100       | 0-10ç§’  |
| ä½é¢‘é•¿å»¶è¿Ÿ | 1ç§’     | 100       | 0-100ç§’ |

### çº¿ç¨‹æ± é…ç½®

```java
// è‡ªå®šä¹‰çº¿ç¨‹æ± å¤§å°
TimeWheelScheduler scheduler = new TimeWheelScheduler() {
            @Override
            protected ExecutorService createTaskExecutor() {
                return Executors.newFixedThreadPool(4); // 4ä¸ªçº¿ç¨‹
            }
        };
```

## æ³¨æ„äº‹é¡¹

### 1. å†…å­˜ç®¡ç†

- æ—¶é—´è½®æ¡¶æ•°é‡å›ºå®šï¼Œå†…å­˜å ç”¨å¯æ§
- ä»»åŠ¡æ‰§è¡Œå®Œæˆåä¼šè‡ªåŠ¨æ¸…ç†
- å»ºè®®å®šæœŸæ£€æŸ¥ä»»åŠ¡æ•°é‡ï¼Œé¿å…å†…å­˜æ³„æ¼

### 2. ç²¾åº¦è€ƒè™‘

- tickMsè¶Šå°ï¼Œç²¾åº¦è¶Šé«˜ï¼Œä½†CPUå ç”¨ä¹Ÿè¶Šé«˜
- å»ºè®®æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©åˆé€‚çš„ç²¾åº¦
- é»˜è®¤100msç²¾åº¦é€‚åˆå¤§å¤šæ•°åœºæ™¯

### 3. çº¿ç¨‹å®‰å…¨

- æ—¶é—´è½®å†…éƒ¨ä½¿ç”¨åŸå­æ“ä½œä¿è¯çº¿ç¨‹å®‰å…¨
- ä»»åŠ¡æ‰§è¡Œåœ¨ç‹¬ç«‹çº¿ç¨‹æ± ä¸­ï¼Œä¸ä¼šé˜»å¡æ—¶é—´è½®çº¿ç¨‹
- æ”¯æŒå¤šçº¿ç¨‹å¹¶å‘æ·»åŠ ä»»åŠ¡

### 4. å¼‚å¸¸å¤„ç†

- ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸ä¼šè¢«æ•è·å¹¶è®°å½•
- å•ä¸ªä»»åŠ¡å¼‚å¸¸ä¸ä¼šå½±å“å…¶ä»–ä»»åŠ¡æ‰§è¡Œ
- å»ºè®®åœ¨ä»»åŠ¡ä¸­æ·»åŠ é€‚å½“çš„å¼‚å¸¸å¤„ç†

## æœ€ä½³å®è·µ

### 1. åˆç†è®¾ç½®å‚æ•°

```java
// æ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¾ç½®åˆé€‚çš„å‚æ•°
TimeWheelScheduler scheduler = new TimeWheelScheduler(
                50,   // 50msç²¾åº¦ï¼Œé€‚åˆéœ€è¦è¾ƒé«˜ç²¾åº¦çš„åœºæ™¯
                200   // 200ä¸ªæ ¼å­ï¼Œæ”¯æŒ0-10ç§’çš„å»¶è¿Ÿ
        );
```

### 2. èµ„æºç®¡ç†

```java
// ç¡®ä¿åœ¨åº”ç”¨å…³é—­æ—¶åœæ­¢è°ƒåº¦å™¨
Runtime.getRuntime().

addShutdownHook(new Thread(() ->{
        scheduler.

stop();
}));
```

### 3. ç›‘æ§å’Œæ—¥å¿—

```java
// æ·»åŠ ç›‘æ§å’Œæ—¥å¿—
scheduler.schedule(delay, unit, () ->{
        try{
        // æ‰§è¡Œä»»åŠ¡
        task.

run();
    }catch(
Exception e){
        logger.

error("ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸",e);
// æ·»åŠ ç›‘æ§æŒ‡æ ‡
        metrics.

incrementCounter("task.error");
    }
            });
```

### 4. æ‰¹é‡ä»»åŠ¡å¤„ç†

```java
// å¯¹äºå¤§é‡ç›¸åŒå»¶è¿Ÿçš„ä»»åŠ¡ï¼Œå¯ä»¥æ‰¹é‡å¤„ç†
List<Runnable> tasks = getBatchTasks();
for(
Runnable task :tasks){
        scheduler.

schedule(delay, unit, task);
}
```

## æ‰©å±•åŠŸèƒ½

### 1. ä»»åŠ¡å–æ¶ˆ

```java
// å¯ä»¥é€šè¿‡ä»»åŠ¡IDå®ç°ä»»åŠ¡å–æ¶ˆåŠŸèƒ½
class CancellableTask {
    private final int taskId;
    private volatile boolean cancelled = false;

    public void cancel() {
        this.cancelled = true;
    }

    public void run() {
        if (!cancelled) {
            // æ‰§è¡Œä»»åŠ¡é€»è¾‘
        }
    }
}
```

### 2. ä»»åŠ¡ä¼˜å…ˆçº§

```java
// å¯ä»¥é€šè¿‡ä»»åŠ¡ä¼˜å…ˆçº§å®ç°ä¸åŒçš„å¤„ç†ç­–ç•¥
class PriorityTask implements Comparable<PriorityTask> {
    private final int priority;
    private final Runnable task;

    @Override
    public int compareTo(PriorityTask other) {
        return Integer.compare(other.priority, this.priority);
    }
}
```

### 3. ä»»åŠ¡ç»Ÿè®¡

```java
// æ·»åŠ ä»»åŠ¡æ‰§è¡Œç»Ÿè®¡åŠŸèƒ½
class TaskStatistics {
    private final AtomicLong totalTasks = new AtomicLong();
    private final AtomicLong completedTasks = new AtomicLong();
    private final AtomicLong failedTasks = new AtomicLong();

    public void recordTaskExecution(boolean success) {
        if (success) {
            completedTasks.incrementAndGet();
        } else {
            failedTasks.incrementAndGet();
        }
    }
}
```

## æ€»ç»“

è¿™ä¸ªè½»é‡çº§æ—¶é—´è½®å®ç°æä¾›äº†ä¸€ä¸ªé«˜æ•ˆã€å¯é ã€æ˜“ç”¨çš„å®šæ—¶ä»»åŠ¡è°ƒåº¦è§£å†³æ–¹æ¡ˆã€‚é€šè¿‡åˆç†çš„è®¾è®¡å’Œä¼˜åŒ–ï¼Œå®ƒèƒ½å¤Ÿæ»¡è¶³å¤§å¤šæ•°å®šæ—¶ä»»åŠ¡è°ƒåº¦çš„éœ€æ±‚ï¼ŒåŒæ—¶ä¿æŒè‰¯å¥½çš„æ€§èƒ½å’Œå¯æ‰©å±•æ€§ã€‚

ä¸»è¦ä¼˜åŠ¿ï¼š

- ğŸš€ **é«˜æ€§èƒ½**: åŸºäºæ—¶é—´è½®ç®—æ³•ï¼ŒO(1)æ“ä½œå¤æ‚åº¦
- ğŸ¯ **é«˜ç²¾åº¦**: æ”¯æŒæ¯«ç§’çº§ç²¾åº¦çš„å®šæ—¶è°ƒåº¦
- ğŸ”§ **æ˜“ç”¨æ€§**: ç®€æ´çš„APIæ¥å£ï¼Œå¿«é€Ÿä¸Šæ‰‹
- ğŸ›¡ï¸ **å¯é æ€§**: çº¿ç¨‹å®‰å…¨ï¼Œå¼‚å¸¸å¤„ç†å®Œå–„
- ğŸ“ˆ **å¯æ‰©å±•**: æ”¯æŒæº¢å‡ºæ—¶é—´è½®ï¼Œå¤„ç†é•¿æ—¶é—´å»¶è¿Ÿ

æ— è®ºæ˜¯ç®€å•çš„å»¶è¿Ÿä»»åŠ¡ï¼Œè¿˜æ˜¯å¤æ‚çš„å®šæ—¶è°ƒåº¦éœ€æ±‚ï¼Œè¿™ä¸ªæ—¶é—´è½®å®ç°éƒ½èƒ½æä¾›ä¼˜ç§€çš„è§£å†³æ–¹æ¡ˆã€‚ 
